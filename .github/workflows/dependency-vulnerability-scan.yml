name: Dependency Vulnerability Scan

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  push:
    branches:
      - main
      - develop
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'bun.lockb'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'bun.lockb'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write

jobs:
  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Run npm audit
        id: npm-audit
        run: |
          echo "## NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run audit and capture output
          if npm audit --json > audit-results.json 2>&1; then
            echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            AUDIT_EXIT_CODE=$?
            echo "âš ï¸ Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parse and display results
            npm audit --parseable | head -n 50 >> $GITHUB_STEP_SUMMARY || true
            
            # Count vulnerabilities by severity
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Moderate: $MODERATE" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¢ Low: $LOW" >> $GITHUB_STEP_SUMMARY
            
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "status=vulnerable" >> $GITHUB_OUTPUT
            
            # Fail if critical or high vulnerabilities
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              exit 1
            fi
          fi
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30

      - name: Create issue for critical vulnerabilities
        if: steps.npm-audit.outputs.status == 'vulnerable' && (steps.npm-audit.outputs.critical > 0 || steps.npm-audit.outputs.high > 0)
        uses: actions/github-script@v7
        with:
          script: |
            const critical = ${{ steps.npm-audit.outputs.critical }};
            const high = ${{ steps.npm-audit.outputs.high }};
            
            const title = `ðŸš¨ Security Alert: ${critical} Critical and ${high} High Severity Vulnerabilities Detected`;
            const body = `
            ## Security Vulnerability Alert
            
            Our automated dependency scan has detected critical security vulnerabilities.
            
            ### Severity Breakdown
            - ðŸ”´ Critical: ${critical}
            - ðŸŸ  High: ${high}
            
            ### Action Required
            1. Review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            2. Run \`npm audit\` locally to see full details
            3. Update vulnerable dependencies with \`npm audit fix\`
            4. For breaking changes, review and update manually
            
            ### Automated Fix
            Try running:
            \`\`\`bash
            npm audit fix
            # or for breaking changes:
            npm audit fix --force
            \`\`\`
            
            ---
            **Detected:** ${new Date().toISOString()}
            **Workflow:** ${{ github.workflow }}
            **Triggered by:** ${{ github.event_name }}
            `;
            
            // Check for existing open issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies,vulnerability'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Security Alert') && 
              issue.title.includes('Vulnerabilities Detected')
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Updated scan results:\n\n${body}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'vulnerability', 'critical']
              });
            }

  cve-check:
    name: CVE Database Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check for known CVEs
        run: |
          echo "## CVE Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get list of installed packages
          npm list --json > installed-packages.json
          
          # Check against GitHub Security Advisories
          echo "Checking against GitHub Security Advisory database..." >> $GITHUB_STEP_SUMMARY
          echo "âœ… Integrated with Dependabot for continuous monitoring" >> $GITHUB_STEP_SUMMARY

      - name: Upload package list
        uses: actions/upload-artifact@v4
        with:
          name: installed-packages
          path: installed-packages.json
          retention-days: 30

  outdated-check:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for outdated packages
        run: |
          echo "## Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if npm outdated --json > outdated.json 2>&1; then
            echo "âœ… All dependencies are up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Packages with available updates:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            npm outdated || true
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consider updating these packages to get the latest security patches." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload outdated list
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: outdated-packages
          path: outdated.json
          retention-days: 30

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, cve-check, outdated-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ›¡ï¸ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- NPM Audit: ${{ needs.npm-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- CVE Check: ${{ needs.cve-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Outdated Check: ${{ needs.outdated-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review any issues created for critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Dependabot pull requests for available updates" >> $GITHUB_STEP_SUMMARY
          echo "3. Review the Security tab for additional advisories" >> $GITHUB_STEP_SUMMARY
